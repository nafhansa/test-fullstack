_format_version: "3.0"

services:
  - name: auth-service
    url: http://auth-service:3001
    routes:
      # Public routes (no auth needed)
      - name: auth-register
        paths:
          - /api/auth/register
        methods:
          - POST
          - OPTIONS
        strip_path: false
        
      - name: auth-login
        paths:
          - /api/auth/login
        methods:
          - POST
          - OPTIONS
        strip_path: false
      
      # Protected routes (need JWT)
      - name: auth-me
        paths:
          - /api/auth/me
        methods:
          - GET
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
      
      - name: auth-refresh-token
        paths:
          - /api/auth/refresh-token
        methods:
          - POST
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
      
      # Internal routes (admin only)
      - name: auth-users
        paths:
          - /api/auth/users
        methods:
          - GET
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123

  - name: product-service
    url: http://product-service:3002
    routes:
      # Routes with ID parameters (higher priority)
      - name: products-detail
        paths:
          - ~/api/products/\d+$
        methods:
          - GET
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
      
      - name: products-update
        paths:
          - ~/api/products/\d+$
        methods:
          - PUT
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
        
      - name: products-delete
        paths:
          - ~/api/products/\d+$
        methods:
          - DELETE
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
      
      # Routes without ID parameters (lower priority)
      - name: products-list
        paths:
          - /api/products
        methods:
          - GET
          - OPTIONS
        strip_path: false
        
      - name: products-create
        paths:
          - /api/products
        methods:
          - POST
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123

  - name: transaction-service
    url: http://transaction-service:3003
    routes:
      # Specific routes first (checkout, history, pay)
      - name: transactions-checkout
        paths:
          - /api/transactions/checkout
        methods:
          - POST
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
      
      - name: transactions-history
        paths:
          - /api/transactions/history
        methods:
          - GET
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
      
      - name: transactions-pay
        paths:
          - /api/transactions/pay
        methods:
          - POST
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
      
      # Detail route with regex (lower priority)
      - name: transactions-detail
        paths:
          - ~/api/transactions/\d+$
        methods:
          - GET
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
      
      # Generic routes (lowest priority)
      - name: transactions-create
        paths:
          - /api/transactions
        methods:
          - POST
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
        
      - name: transactions-list
        paths:
          - /api/transactions
        methods:
          - GET
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123

  - name: rbac-service
    url: http://rbac-service:3004
    routes:
      - name: rbac-get-users
        paths:
          - /api/users
        methods:
          - GET
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
      
      - name: rbac-create-user
        paths:
          - /api/users
        methods:
          - POST
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
      
      - name: rbac-update-user
        paths:
          - ~/api/users/(\d+)$
        methods:
          - PUT
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
      
      - name: rbac-delete-user
        paths:
          - ~/api/users/(\d+)$
        methods:
          - DELETE
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123

# Global Plugins
plugins:
  - name: cors
    config:
      origins:
        - http://localhost:5173
        - http://localhost:3000
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Content-Type
        - Authorization
        - X-INTERNAL-KEY
      credentials: true
      max_age: 3600
