_format_version: "3.0"

services:
  # ===== AUTH SERVICE =====
  - name: auth-service
    url: http://auth-service:3001
    routes:
      # Public routes
      - name: auth-register
        paths:
          - /api/auth/register
        methods:
          - POST
          - OPTIONS
        strip_path: false
        
      - name: auth-login
        paths:
          - /api/auth/login
        methods:
          - POST
          - OPTIONS
        strip_path: false
      
      # ✅ FIX: Protected routes (need JWT)
      - name: auth-me
        paths:
          - /api/auth/me
        methods:
          - GET
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
      
      - name: auth-refresh-token
        paths:
          - /api/auth/refresh-token
        methods:
          - POST
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
      
      # Internal routes
      - name: auth-users
        paths:
          - /api/auth/users
        methods:
          - GET
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123

  # ===== PRODUCT SERVICE =====
  - name: product-service
    url: http://product-service:3002
    routes:
      - name: products-detail
        paths:
          - ~/api/products/\d+$
        methods:
          - GET
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
      
      - name: products-update
        paths:
          - ~/api/products/\d+$
        methods:
          - PUT
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
        
      - name: products-delete
        paths:
          - ~/api/products/\d+$
        methods:
          - DELETE
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
      
      - name: products-list
        paths:
          - /api/products
        methods:
          - GET
          - OPTIONS
        strip_path: false
        
      - name: products-create
        paths:
          - /api/products
        methods:
          - POST
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123

  # ===== TRANSACTION SERVICE =====
  - name: transaction-service
    url: http://transaction-service:3003
    routes:
      # ✅ FIX: Cart endpoints (BARU - Sesuai PDF)
      - name: cart-add
        paths:
          - /api/cart/add
        methods:
          - POST
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
              replace:
                uri: /api/transactions/cart/add
      
      - name: cart-get
        paths:
          - ~/api/cart(/\d+)?$
        methods:
          - GET
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
              replace:
                uri: /api/transactions/cart
      
      # Checkout & History
      - name: transactions-checkout
        paths:
          - /api/transactions/checkout
        methods:
          - POST
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
      
      - name: transactions-history
        paths:
          - /api/transactions/history
        methods:
          - GET
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
      
      - name: transactions-pay
        paths:
          - /api/transactions/pay
        methods:
          - POST
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
      
      - name: transactions-detail
        paths:
          - ~/api/transactions/\d+$
        methods:
          - GET
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
      
      - name: transactions-create
        paths:
          - /api/transactions
        methods:
          - POST
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
        
      - name: transactions-list
        paths:
          - /api/transactions
        methods:
          - GET
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123

  # ===== RBAC SERVICE ===== ✅ FIX: Endpoint sesuai PDF
  - name: rbac-service
    url: http://rbac-service:3004
    routes:
      - name: rbac-get-users
        paths:
          - /api/users
        methods:
          - GET
          - OPTIONS
        strip_path: true  # /api/users → /users
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
      
      - name: rbac-add-user
        paths:
          - /api/users
        methods:
          - POST
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
              replace:
                uri: /add_users  # ✅ Sesuai PDF
      
      - name: rbac-update-user
        paths:
          - ~/api/users/(\d+)$
        methods:
          - PUT
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
              # no URI replace: forward original /api/users/:id to upstream
      
      - name: rbac-delete-user
        paths:
          - ~/api/users/(\d+)$
        methods:
          - DELETE
          - OPTIONS
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-INTERNAL-KEY:supersecretkey123
              # no URI replace: forward original /api/users/:id to upstream

# Global Plugins
plugins:
  - name: cors
    config:
      origins:
        - http://localhost:5173
        - http://localhost:3000
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Content-Type
        - Authorization
        - X-INTERNAL-KEY
      credentials: true
      max_age: 3600